<!doctype html>
<html lang="en" ng-app>
  <head>
    <title>Tumblr Scraper Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/bootstrap-responsive.min.css">
    <style>
      body {
        padding-top: 60px;
      }
    </style>
    <script>
      function ScrapeController($scope) {
        var socket = io.connect();

        $scope.dbRunState = '';
        $scope.appRunState = '';
        $scope.tumblrSyncRunState  = '';
        $scope.fsSyncRunState = '';
        $scope.dbRunState = '';
        $scope.error = 'no error';
        $scope.tumblrPostsSoFar = 0;
        $scope.tumblrCurrentTime = new Date();
        $scope.logBuffer = [];

        socket.on('connect', function () {
        });

        socket.on('update', function (object) {
          for (var property in object) {
            $scope.$apply(function updateCommand() {
              switch(property) {
                
                case 'tumblrPostsSoFar':
                  $scope.tumblrPostsSoFar = object[property];
                  break;
                  
                case 'tumblrCurrentTime':
                  $scope.tumblrCurrentTime = object[property];
                  break;
                  
                case 'tumblrSyncRunState':
                  $scope.tumblrSyncRunState = object[property];
                  break;
              
                case 'appRunState':
                  $scope.appRunState = object[property];
                  break;
                
                default:
                  $scope.error = 'bad command from server:'+ property + 
                                 ':' + object[property];
              }
            });
          }
        });
        
        socket.on('log', function (message) {
          $scope.$apply(function updateLogBuffer () {
            $scope.logBuffer.unshift(message);
            if ($scope.logBuffer.length > 20)
              $scope.logBuffer.pop();
          });
        });

        $scope.startTumblrSync = function() {
          socket.emit('command','tumbsyncstart');
        };
        
        $scope.stopTumblrSync = function() {
          socket.emit('command','tumbsyncstop');
        }
      }
      
    </script>
  </head>
  
  <body>
    <div class="container" ng-controller="ScrapeController">
      <div class="navbar navbar-fixed-top navbar-inverse">
        <div class="navbar-inner">
          <div class="pull-right">
            <a href="https://c9.io" class="brand">Scraper</a>
          </div>
        </div>
      </div>
      <div class="page-header">
        <h1>Dashboard</h1>
      </div>
      
      <div class="row">
        <div class="span4">
          <ul class="nav nav-list well">
            <li class="nav-header">Service Information</li>
            <small>
              <li>Scraper Status=<b>{{appRunState}}</b></li>
              <li>TumbSync Status=<b>{{tumblrSyncRunState}}</b></li>
              <li>Command flag=<b>{{commandFlag}}</b></li>
            </small>
          </ul>
          <ul class="nav nav-list well">
            <li class="nav-header">Tumblr Sync Information</li>
            <small>
              <li>Total posts fetched = {{tumblrPostsSoFar}}</li>
              <li>Datestamp reached = {{tumblrCurrentTime}}</li>
            </small>
          </ul>
        </div>
        
        <ul class="span8">
          <form ng-submit="startTumblrSync()">
             <input type="submit" class="span2 btn btn-primary" value="Start TumbSync" ng-disabled="false">
          </form>
          <form ng-submit="stopTumblrSync()">
            <input type="submit" class="span2 btn btn-primary" value="Stop TumbSync" ng-disabled="false">
          </form>
        </ul>
        
        <div class="span8">
          <table class="table table-striped table-bordered">
            <thead>
              <tr>
                <th class="span8">Log messages</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="message in logBuffer" ng-click="setPost(p.key)">
                <td class="span8" ng-bind=message></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/angular.min.js"></script>
  </body>
</html>
